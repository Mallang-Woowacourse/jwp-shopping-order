# github actions ì—ì„œ ë³´ì´ëŠ” ì´ë¦„ì…ë‹ˆë‹¤
name: deploy

# ì–¸ì œ ì´ yml ì„ ì‘ë™ì‹œí‚¤ëŠ”ì§€ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤
on:
  # ìˆ˜ë™ìœ¼ë¡œ ì‘ë™ì‹œí‚¬ ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ì„¤ì •ì…ë‹ˆë‹¤
  workflow_dispatch:
  # ì–´ëŠ ë¸Œëœì¹˜ì—ì„œë“  push ê°€ ë°œìƒí•˜ë©´ job ì„ ì‹¤í–‰í•©ë‹ˆë‹¤
  push:
jobs:
  # ì´ job ì˜ ì´ë¦„ì…ë‹ˆë‹¤
  deploy:
    # ìš°ë¦¬ê°€ ë“±ë¡í•œ Github Self Hosted Runner ì—ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤
    runs-on: self-hosted
    env:
      SPRING_PROFILES_ACTIVE: ${{ secrets.SPRING_PROFILES_ACTIVE }}
      RDS_DRIVER: ${{ secrets.RDS_DRIVER }}
      RDS_URL: ${{ secrets.RDS_URL }}
      RDS_USERNAME: ${{ secrets.RDS_USERNAME }}
      RDS_PASSWORD: ${{ secrets.RDS_PASSWORD }}  
    # ì¡ì˜ êµ¬ì²´ì ì¸ ë‹¨ê³„ì…ë‹ˆë‹¤
    steps:
      # ì²˜ìŒ _work í´ë”ì— github actions í”„ë¡œê·¸ë¨ì´ íŒŒì¼ì„ ìˆ˜ì •í•  ê¶Œí•œì´ ì—†ì–´ì„œ, ê¶Œí•œì„ ë¶€ì—¬í•´ ì£¼ê¸° ìœ„í•œ ì‘ì—…ì…ë‹ˆë‹¤
      # ì´ ëª…ë ¹ì„ í†µí•´ì„œ ì´ë¯¸ ìˆëŠ” í´ë”ì— git pull ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
      - uses: actions/checkout@v3
        with:
          ref: step1
          
      - name: ğŸ³ ë¹Œë“œ ğŸ‰
        run: |
          git branch
          ./gradlew clean bootJar
     
      - name: ğŸ”ª 8080 í¬íŠ¸ ì£½ì—¬ë²„ëŸ¬ ğŸ¤¬
        run: |
          if sudo lsof -i :8080; then
            echo "Port 8080 is already in use. Killing the process..."
            sudo lsof -i :8080 | awk 'NR!=1 {print $2}' | sudo xargs kill -9
          fi
          
      - name: ğŸ³ í™˜ê²½ë³€ìˆ˜ Github Runner -> EC2 Server ì´ë™ ğŸ‰
        run: |
          echo SPRING_PROFILES_ACTIVE=env.SPRING_PROFILES_ACTIVE >> env.yml
          echo RDS_DRIVER=env.RDS_DRIVER >> env.yml
          echo RDS_URL=env.RDS_URL >> env.yml
          echo RDS_USERNAME=env.RDS_USERNAME >> env.yml
          echo RDS_PASSWORD=env.RDS_PASSWORD >> env.yml
      
      - name: ğŸ³ í™˜ê²½ë³€ìˆ˜ ì ìš© ğŸ‰
        
           
      - name: ğŸ³ JAR ì‹¤í–‰ ğŸ‰
        run: |
          sudo nohup java -jar ./build/libs/jwp-shopping-order.jar &
        
        
      
